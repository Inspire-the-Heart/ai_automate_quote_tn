name: Vionix Pipeline

on:
  push:
  schedule:
    - cron: "0 13 * * *"   # Tamil

concurrency:
  group: vionix-pipeline-tamil
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"

  GEMENI_KEY: ${{ secrets.GEMENI_KEY }}
  GEMENI_MODEL: ${{ secrets.GEMENI_MODEL }}
  ADJECTIVES: ${{ secrets.ADJECTIVES }}
  THEMES: ${{ secrets.THEMES }}
  LANGUAGE: ${{ secrets.LANGUAGE }}

  S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
  S3_SECRETE_KEY: ${{ secrets.S3_SECRETE_KEY }}
  S3_ZONE: ${{ secrets.S3_ZONE }}
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  S3_URL: ${{ secrets.S3_URL }}

  FB_VERSION: ${{ secrets.FB_VERSION }}
  FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
  FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}

  INSTA_PAGE_ID: ${{ secrets.INSTA_PAGE_ID }}
  INSTA_PAGE_TOKEN: ${{ secrets.INSTA_PAGE_TOKEN }}

  THREADS_VERSION: ${{ secrets.THREADS_VERSION }}
  THREADS_PAGE_ID: ${{ secrets.THREADS_PAGE_ID }}
  THREADS_PAGE_TOKEN: ${{ secrets.THREADS_PAGE_TOKEN }}

  YT_JSON: ${{ secrets.YT_JSON }}
  JSON_CLIENT_YT: ${{ secrets.JSON_CLIENT_YT }}
  JSON_OAUTH_YT: ${{ secrets.JSON_OAUTH_YT }}

  HF_TOKEN: ${{ secrets.HF_TOKEN }}

  PINTEREST_CLIENT_ID: ${{ secrets.PINTEREST_CLIENT_ID }}
  PINTEREST_CLIENT_SECRET: ${{ secrets.PINTEREST_CLIENT_SECRET }}
  PINTEREST_ACCESS_TOKEN: ${{ secrets.PINTEREST_ACCESS_TOKEN }}
  PINTEREST_BOARD_ID: ${{ secrets.PINTEREST_BOARD_ID }}
  PINTEREST_REFRESH_TOKEN: ${{ secrets.PINTEREST_REFRESH_TOKEN }}
  PINTEREST_API_URL: ${{ secrets.PINTEREST_API_URL }}
  PINTEREST_STATIC_DOMINANT_COLOR: ${{ secrets.PINTEREST_STATIC_DOMINANT_COLOR }}

  VIONIX_GIST_ID: ${{ secrets.VIONIX_GIST_ID }}

  VIONIX_WHEEL_DIR: .vionix-wheel

jobs:
  run:
    name: ðŸš€ Run Tamil Pipeline
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      # -------------------------------------------------
      # Python
      # -------------------------------------------------
      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      # -------------------------------------------------
      # Cache pip
      # -------------------------------------------------
      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-py311-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-py311-

      # -------------------------------------------------
      # Cache Vionix wheel (commit-based)
      # -------------------------------------------------
      - name: Cache Vionix wheel
        uses: actions/cache@v5
        with:
          path: ${{ env.VIONIX_WHEEL_DIR }}
          key: vionix-${{ runner.os }}-py311-${{ secrets.RELEASE_TAG }}

      # -------------------------------------------------
      # Build tools
      # -------------------------------------------------
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip build

      # -------------------------------------------------
      # Build Vionix wheel ONLY if missing
      # -------------------------------------------------
      - name: Build Vionix wheel (if needed)
        env:
          GH_PAT: ${{ secrets.GH_TOKEN }}
        run: |
          mkdir -p $VIONIX_WHEEL_DIR
          if ! ls $VIONIX_WHEEL_DIR/*.whl 1>/dev/null 2>&1; then
            echo "ðŸ”¨ Building Vionix from commit/tag: ${{ secrets.RELEASE_TAG }}"
            pip wheel \
              git+https://x-access-token:${GH_PAT}@github.com/simplycodesmart/Vionix.git@${{ secrets.RELEASE_TAG }} \
              -w $VIONIX_WHEEL_DIR
          else
            echo "âœ… Using cached Vionix wheel"
          fi

      # -------------------------------------------------
      # Install dependencies
      # -------------------------------------------------
      - name: Install dependencies
        run: |
          pip install $VIONIX_WHEEL_DIR/*.whl
          pip install -r requirements.txt --prefer-binary

      # -------------------------------------------------
      # FFmpeg
      # -------------------------------------------------
      - name: Install FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: "6.1.0"

      # -------------------------------------------------
      # Create auth files
      # -------------------------------------------------
      - name: Create client_secrets.json & oauth.json
        run: |
          python - <<'EOF'
          import json, os
          json.dump(json.loads(os.environ["JSON_CLIENT_YT"]), open("client_secrets.json","w"), indent=2)
          json.dump(json.loads(os.environ["JSON_OAUTH_YT"]), open("oauth.json","w"), indent=2)
          print("âœ… Auth files created")
          EOF

      # -------------------------------------------------
      # Copy assets (Tamil font)
      # -------------------------------------------------
      - name: Copy assets
        run: |
          cp assets/bg.png .
          cp assets/font_tn.ttf .
          cp assets/output_image.png .

      # -------------------------------------------------
      # Pick random music
      # -------------------------------------------------
      - name: Pick random music
        id: music
        run: |
          NUM=$((1 + RANDOM % 23))
          echo "num=$NUM" >> $GITHUB_OUTPUT
          cp "assets/music/$NUM.mp3" .

      # -------------------------------------------------
      # Run main
      # -------------------------------------------------
      - name: Execute main
        run: |
          python -c "import Vionix; print('âœ… Vionix import OK')"
          python main.py "${{ steps.music.outputs.num }}"
